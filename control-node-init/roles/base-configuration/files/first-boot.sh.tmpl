#!/bin/bash

# disable the subscription required repos
sed -i 's/^/# /' /etc/apt/sources.list.d/*

# add the no-sub repo
cat <<EOF > /etc/apt/sources.list.d/pve-no-sub.list
# no-subscription repo
deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
EOF

# install sudo
apt update
apt install sudo

# create the ansible user
adduser --comment "Ansible" --disabled-password ansible
echo "ansible ALL=(ALL:ALL) NOPASSWD:ALL" > /etc/sudoers.d/ansible

# add our pub ssh key to ansible's authorized keys
mkdir --mode=700 /home/ansible/.ssh

cat <<EOF > /home/ansible/.ssh/authorized_keys
{AUTHORIZED_KEYS}
EOF

chmod 640 /home/ansible/.ssh/authorized_keys
chown -R ansible:ansible /home/ansible/.ssh
